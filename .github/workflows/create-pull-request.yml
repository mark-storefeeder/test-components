name: Create pull request

on:
  workflow_call:
    inputs:
      branch_name:
        required: true
        type: string

jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create pull request
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Check if a pull request already exists
            const existingPRs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: '${{ inputs.branch_name }}',
              base: 'main',
              state: 'open'
            });

            if (existingPRs.data.length === 0) {
              await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '${{ inputs.branch_name }}',
                head: '${{ inputs.branch_name }}',
                base: 'main'
              })
              .then(async (response) => {
                // Add 'don't squash' label to the pull request
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: response.data.number,
                  labels: ['don\'t squash']
                });
              });
            }
    